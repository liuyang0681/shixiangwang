---
title: "使用purrr和broom处理多个模型"
author: 王诗翔
date: 2018-10-15
slug: "purrr-and-broom"
categories: 
    - R
tags:
    - purrr
    - broom
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE, dev = "png", comment = "#>")
#Sys.setlocale('LC_ALL','C') # Embed this directly in the Rmarkdown script that contains the Chinese character comment
options(digits=3)
options(max.print=200)
```

> 整理自《R for data science》

本文介绍3种方法用于处理大量模型。

* 使用多个简单模型更好地理解复杂数据集。
* 使用列表列在数据框中保存任意数据结构。
* 使用broom包将模型转换为整洁数据。


## 准备工作

```{r}
library(modelr)
library(tidyverse)
```

## 列表列

**列表列是隐式定义在数据框中的：数据框是由相同长度的向量组成的命名列表。一个列表就是一个向量（嵌套向量），因此完全可以将列表作为数据框的一列**。但在R基础包中创建列表列是非常困难的，且data.frame()函数时将列表作为列的列表来处理的：

```{r}
data.frame(x = list(1:3, 3:5))
```

要想不这样处理，可以使用I()函数，但输出结果难以解释：

```{r}
data.frame(
    x = I(list(1:3, 3:5)),
    y = c("1, 2", "3, 4, 5")
)
```

tibble更懒惰一些，它不会修改输入，但更容易创建列表列，输出的内容也非常容易理解：

```{r}
tibble(
    x = list(1:3, 3:5),
    y = c("1, 2", "3, 4, 5")
)
```

使用tribble()函数则更容易，它可以自动识别：

```{r}
tribble(
    ~x, ~y,
    1:3, "1, 2",
    3:5, "3, 4, 5"
    
)
```

**列表列的最大用处是作为一种中间数据结构**。想要直接处理列表列比较困难，因为多数R函数都只处理原子向量或数据框。但列表列可以将相关条目统一保存在一个数据框中，光这一点就值得我们学习它。

## 创建列表列

一般我们会使用下面3种方式创建列表列。

* 使用tidyr::nest()函数将分组数据转换为嵌套数据框，嵌套数据框中会包含列表列。
* 使用mutate()函数以及能够返回列表的向量化函数
* 使用summarize()函数以及能够返回多个结果的摘要函数

### 使用嵌套

nest()函数有两种使用方式。

一是当用于分组数据时，nest()函数会保留用于分组的列，而其他所有数据归并到列表中。

二是可以在未分组的数据上使用nest()函数，此时需要指定嵌套哪些列。

### 使用向量化函数

一些常用函数接受一个原子向量并返回一个列表。例如stringr::str_split()函数接受一个字符向量，并返回字符向量的一个列表。如果在mutate()中使用该函数，就会得到列表列。

```{r}
df = tribble(
    ~x1,
    "a,b,c",
    "d,e,f,g"
)

df %>% 
    mutate(x2 = stringr::str_split(x1, ","))
```

unnest()函数知道如何处理这些向量列表。

```{r}
df %>% 
    mutate(x2 = stringr::str_split(x1, ",")) %>% 
    unnest()
```

另一个示例是使用purrr包中的map()、map2()以及pmap()函数。

```{r}
sim = tribble(
    ~f, ~params,
    "runif", list(min = -1, max = -1),
    "rnorm", list(sd = 5),
    "rpois", list(lambda = 10)
)

sim %>% 
    mutate(sims = invoke_map(f, params, n = 10))
```

### 使用多值摘要

summarize()函数的一个局限性是，只能使用返回单一值的摘要函数。